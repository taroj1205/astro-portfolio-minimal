---
import { Image as AstroImage } from 'astro:assets'
import type { ImageMetadata } from 'astro'

interface Props {
  src: ImageMetadata
  alt: string
  class?: string
  style?: string
  layout?: 'constrained' | 'fixed' | 'full-width' | 'none'
  loading?: 'lazy' | 'eager'
  decoding?: 'async' | 'auto' | 'sync'
  fetchpriority?: 'high' | 'low' | 'auto'
}

const {
  src,
  alt,
  class: className,
  style: styleProp,
  layout = 'constrained',
  loading = 'lazy',
  decoding = 'async',
  fetchpriority,
  ...rest
} = Astro.props as Props

const computedFetchPriority =
  fetchpriority ?? (loading === 'eager' ? 'high' : 'auto')
const resolvedImageUrl = Astro.site
  ? new URL(src.src, Astro.site).toString()
  : src.src
const placeholderUrl = `https://unpic.pics/placeholder/?url=${encodeURIComponent(
  resolvedImageUrl
)}`
const placeholderStyle = `background-image: url("${placeholderUrl}"); background-size: cover; background-position: center; background-repeat: no-repeat;`
const combinedStyle = styleProp
  ? `${placeholderStyle} ${styleProp}`
  : placeholderStyle
---

<AstroImage
  src={src}
  alt={alt}
  class={className}
  style={combinedStyle}
  layout={layout}
  loading={loading}
  decoding={decoding}
  fetchpriority={computedFetchPriority}
  {...rest}
/>
