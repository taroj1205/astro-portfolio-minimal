---
import { Picture } from 'astro:assets'
import * as fs from 'node:fs/promises'
import { getPixels } from '@unpic/pixels'
import { blurhashToImageCssObject } from '@unpic/placeholder'
import type { ImageMetadata } from 'astro'
import { encode } from 'blurhash'

const blurhashCache = new Map<string, string>()
const kebabCase = (value: string): string =>
  value.replace(/[A-Z]/g, match => `-${match.toLowerCase()}`)

interface Props {
  src: ImageMetadata
  alt: string
  class?: string
  style?: string
  layout?: 'constrained' | 'fixed' | 'full-width' | 'none'
  loading?: 'lazy' | 'eager'
  decoding?: 'async' | 'auto' | 'sync'
  fetchpriority?: 'high' | 'low' | 'auto'
  formats?: string[]
}

const {
  src,
  alt,
  class: className,
  style: styleProp,
  layout = 'constrained',
  loading = 'lazy',
  decoding = 'async',
  fetchpriority,
  formats = ['webp', 'avif'],
  ...rest
} = Astro.props as Props

async function resolveBlurhashStyle(image: ImageMetadata): Promise<string> {
  const fsPath = (image as ImageMetadata & { fsPath?: string }).fsPath
  if (!fsPath) {
    return ''
  }

  if (!['jpg', 'jpeg', 'png'].includes(image.format)) {
    return ''
  }

  const cached = blurhashCache.get(fsPath)
  if (cached) {
    return cached
  }

  try {
    const fileData = await fs.readFile(fsPath)
    const { width, height, data } = await getPixels(fileData)
    const pixelData =
      data instanceof Uint8ClampedArray ? data : Uint8ClampedArray.from(data)
    const blurhash = encode(pixelData, width, height, 4, 4)
    const css = Object.entries({
      ...blurhashToImageCssObject(blurhash),
    })
      .map(([key, value]) => `${kebabCase(key)}: ${value};`)
      .join(' ')
    blurhashCache.set(fsPath, css)
    console.log(css)
    return css
  } catch {
    return ''
  }
}

const computedFetchPriority =
  fetchpriority ?? (loading === 'eager' ? 'high' : 'auto')
const placeholderStyle = await resolveBlurhashStyle(src)
const combinedStyle = [placeholderStyle, styleProp].filter(Boolean).join(' ')
---

<Picture
  src={src}
  alt={alt}
  class={className}
  style={combinedStyle}
  layout={layout}
  loading={loading}
  decoding={decoding}
  fetchpriority={computedFetchPriority}
  formats={formats}
  {...rest}
/>
